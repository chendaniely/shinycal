---
title: "streamer_info"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{streamer_info}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Obtaining metadata associated with streamers

The goal of this vignette is to illustrate how we can get interesting metadata associated with each streamer via the Twitch and YouTube APIs. 

## Setup

```{r setup, include = FALSE}
library(twitchr)
library(httr)
library(calendar)
library(caldav)
library(dplyr)
library(yaml)

readRenviron(".Renviron")
```

## Twitch streamer metadata

```{r twitchauth}
# set up authentication via environment variables
twitch_auth()
```

Authentication is successful!  Now let's experiment with the functions in the `twitchr` package, as well as custom explorations of obtaining a streamer's calendar via the Twitch API directly, see docs [here](https://dev.twitch.tv/docs/api/reference/#get-channel-icalendar)


## Obtain streamer YAML file data

```{r yamlparsing}
yml_file <- "data-raw/streamers.yml"
yml_data <- yaml::read_yaml(file = yml_file)

# functions are in separate script now
source("R/mod_cal_viewer_fct_helpers.R")

streamer_data <- tibble(yml_data$streamers) %>%
  tidyr::unnest_wider(1) %>%
  filter(platform == "twitch") %>%
  mutate(id = purrr::map_chr(user_id, ~get_twitch_id(user_name = .x))) %>%
  mutate(schedule_data = purrr::map(id, ~get_twitch_schedule(.x)),
         video_id = purrr::map_chr(id, ~get_twitch_videos(.x)))
```
### Import calendar

```{r caltry}

user <- get_users(login = "aftonsteps")

r <- httr::GET("https://api.twitch.tv/helix/schedule/icalendar", query = list(broadcaster_id = user$id))
status_code(r)
x <- content(r, "text")

res <- withr::with_tempfile("tf", {
  cat(x, file = tf)
  ic_read(tf)
})
```

### Import stream schedule

```{r schedule}
r <- httr::GET("https://api.twitch.tv/helix/schedule", query = list(broadcaster_id = user$id))
status_code(r)

res2 <- content(r, "parsed")

res3 <- get_schedule(broadcaster_id = user$id) %>%
  .[["data"]] %>%
  tibble()

res3
```

### Import additional metadata

```{r other-meta}
videos <- get_videos(user_id = user$id, first = 100) 

videos_play <- videos$data %>%
  tibble() %>%
  mutate(video_id = purrr::map_chr(url, ~{
    tmp <- stringr::str_split(.x, "/")
    n_items <- length(tmp[[1]])
    res <- tmp[[1]][n_items]
    return(res)
  }))

videos_df <- videos$data %>%
  mutate(video_id = purrr::map_chr(url, ~{
    tmp <- stringr::str_split(.x, "/")
    n_items <- length(tmp[[1]])
    res <- tmp[[1]][n_items]
    return(res)
  }))

# video id 1060733999
followers <- get_follows(to_id = user$id, first = 100)
followers_df <- followers$data

```

## YouTube stream metadata

```{r youtube, eval=FALSE}
channel_id <- "UCeiiqmVK07qhY-wvg3IZiZQ"
part <- "liveStreamingDetails"
part <- "snippet,contentDetails"
part <- "snippet,contentDetails,liveStreamingDetails"
#base_url <- "https://www.googleapis.com/youtube/v3/channels"
base_url <- "https://www.googleapis.com/youtube/v3/liveBroadcasts"
base_url <- "https://www.googleapis.com/youtube/v3/videos"
yt_request <- httr::GET(base_url,
                        query = list(key = Sys.getenv("YOUTUBE_API_KEY"),
                                     id = channel_id,
                                     part = part))

status_code(yt_request)

res3 <- content(yt_request, "parsed")
```